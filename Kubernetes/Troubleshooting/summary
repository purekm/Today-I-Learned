Pod
- Pending: 아직 노드에 할당되기 전으로, 리소스 및 스케줄 조건 확인
- Wating: 노드에 할당됐지만 컨테이너가 실행되지 않는 상태로, 이미지 확인
- Terminating: 삭제를 했지만 종료되지 않는 상태로, admission webhook 의심
- Running: 스펙 확인

Service
Endpoint부터 확인.
만약 엔드포인트가 없으면, Selector와 label이 일치하지 않거나 port가 일치하지 않는 것

Cluster(node, controlplane, network, etcd)
먼저 노드 상태부터 Ready인지 확인

Not Ready라면 taints, conditions, events, kubelet 상태 확인

조금 더 깊게 보려면 로그 확인
journalctl로 확인 가능

먼저 node가 문제가 있다?
=> Condition 확인
=> Lab의 경우엔 kubelet 문제
=> systemctl status kubelet으로 확인
=> journalctl -u kubelet으로 확인하고 E가 있는 줄이 에러이니까 참조
journalctl 명령어로 확인할 때 글이 잘려서 안보일 수 있으니까 끝에 -f 옵션 추가하면 좋음


| 대상            | 주요 문제 유형                                | 핵심 트러블슈팅 포인트                                  |
| ------------- | --------------------------------------- | --------------------------------------------- |
| Pod           | Pending / Waiting / Terminating / 동작 오류 | describe, 이벤트, 이미지 풀, YAML 오타, webhook, probe |
| Deployment    | Pod 생성 실패                               | describe, Pod 트러블슈팅으로 연결                      |
| Service       | 트래픽 전달되지 않음                             | EndpointSlice, selector-label, port 매핑        |
| Node          | NotReady / Unknown                      | node describe, kubelet 로그, node 조건            |
| Control Plane | apiserver/scheduler/controller 장애       | 로그 분석, etcd 상태 확인                             |
| Cluster       | 네트워크/스토리지/VM 장애                         | cluster-info dump, HA 구성, 백업                  |


---

Kubernetes Networking 

시험에서 네트워크 문제는 대부분 **CNI / CoreDNS / kube-proxy / Service** 네 가지 중 하나에서 발생한다.
아래 내용만 알고 있으면 대부분의 문제를 해결할 수 있다.

---

# 1. CNI (Pod Network)

쿠버네티스는 기본 Pod 네트워크가 없기 때문에 **반드시 CNI를 설치해야 Pod 통신이 가능**하다.
설치는 다음처럼 매우 단순하다:

```bash
kubectl apply -f <CNI-YAML-URL>   # 시험에서 URL 제공됨
```

## CNI 비교 (시험용 핵심)

| CNI         | Pod Network | NetworkPolicy | 특징                           |
| ----------- | ----------- | ------------- | ---------------------------- |
| **Flannel** | ✔           | ❌ 미지원         | 가장 단순함, 시험에서 자주 등장           |
| **Weave**   | ✔           | ✔ 지원          | 설치 쉽고 mesh 구조                |
| **Calico**  | ✔           | ✔ **강력 지원**   | 프로덕션 표준, BGP/VXLAN, 가장 기능 많음 |

### 자주 나오는 포인트

* CoreDNS가 **Pending** → CNI **미설치**가 90% 원인
* NetworkPolicy가 **동작 안함** → Flannel 사용 중일 가능성 높음
* `/etc/cni/net.d` 에 여러 파일 있으면 **알파벳 순 첫 번째 파일이 적용됨**

---

# 2. CoreDNS (클러스터 DNS)

Pod가 이름 기반으로 Service를 찾도록 만드는 DNS 컴포넌트.

### CoreDNS 구성 요소

* Deployment: `coredns`
* Service: `kube-dns` (port 53)
* ConfigMap: `coredns`
* Corefile 내부에 DNS 설정 존재

### CoreDNS가 정상 동작하려면

* CNI가 먼저 설치되어 Pod-to-Pod 통신이 가능해야 함
* CoreDNS Pod가 Running 상태여야 함

### CoreDNS Troubleshooting 핵심

1. **Pending**
   → CNI 미설치.

2. **CrashLoopBackOff**

   * SELinux + 오래된 Docker 문제
   * DNS Loop (`/etc/resolv.conf` 가 자체 DNS를 가리킴)
   * 해결: kubelet에 resolvConf 지정

     ```yaml
     resolvConf: /run/systemd/resolve/resolv.conf
     ```

3. **kube-dns Endpoints 없음**

   ```bash
   kubectl -n kube-system get ep kube-dns
   ```

   → CoreDNS Deployment 문제 또는 selector mismatch

4. 외부 DNS가 안 됨
   → Corefile의 `forward . /etc/resolv.conf` 확인

---

# 3. kube-proxy (Service Routing)

Service의 **ClusterIP/NodePort → Pod** 트래픽을 실제로 전달하는 핵심 컴포넌트.

### kube-proxy 설치 형태

* kubeadm 클러스터: **DaemonSet**

### kube-proxy 실행 설정

```
--config=/var/lib/kube-proxy/config.conf
--hostname-override=$(NODE_NAME)
```

### kube-proxy Troubleshooting 핵심

1. kube-proxy Pod가 Running인지 확인

   ```bash
   kubectl get pods -n kube-system -l k8s-app=kube-proxy
   ```

2. 로그 확인

   ```bash
   kubectl logs -n kube-system ds/kube-proxy
   ```

3. configmap 확인

   ```bash
   kubectl -n kube-system get cm kube-proxy -o yaml
   ```

4. 노드의 서비스 포트가 열렸는지 확인

   ```bash
   netstat -plan | grep kube-proxy
   ```

문제의 90%는:

* config.conf 누락
* kubeconfig 오류
* iptables/ipvs 모드 설정 문제

---

# 4. Service & Cluster Networking Quick Checks

**ClusterIP가 안 됨 → kube-proxy 문제**
**DNS 이름이 안 됨 → CoreDNS 문제**
**Pod 간 ping 불가 → CNI 문제**

### 가장 빠르게 문제를 분류하는 법

| 시나리오                    | 원인 가능성        |
| ----------------------- | ------------- |
| CoreDNS Pending         | CNI 미설치       |
| Pod 간 ping 불가           | CNI 문제        |
| Service ClusterIP 접근 불가 | kube-proxy 문제 |
| DNS lookup 안 됨          | CoreDNS 문제    |
| NetworkPolicy 적용 안 됨    | Flannel 사용 중  |

---

# 5. 초간단 실전 플로우 (시험 도중 바로 적용)

### 1단계: CNI 확인

```bash
kubectl get pods -n kube-system | grep cni
ls /etc/cni/net.d   # 노드에서 확인
```

### 2단계: CoreDNS 상태

```bash
kubectl -n kube-system get pods -l k8s-app=kube-dns
kubectl -n kube-system get ep kube-dns
```

### 3단계: kube-proxy 상태

```bash
kubectl -n kube-system get pods -l k8s-app=kube-proxy
kubectl logs -n kube-system ds/kube-proxy
```

### 4단계: Service 동작 확인

```bash
kubectl get svc
kubectl describe svc <name>
```

### 5단계: Pod 내부에서 DNS 테스트

```bash
kubectl exec -it <pod> -- nslookup myservice.default
```

---

# 6. 가장 중요한 6줄 요약 

* **CNI 설치 안 하면 모든 네트워크 기능이 망가짐 → CoreDNS Pending**
* **Flannel = NetworkPolicy 안 됨**
* **Calico = 정책 기능 최강 + BGP/VXLAN**
* **DNS 안 될 때는 CoreDNS Deployment / Endpoints / resolv.conf 확인**
* **ClusterIP 문제는 kube-proxy 문제일 확률 높음**
* **/etc/cni/net.d 의 파일은 알파벳 순으로 처리됨**

---


